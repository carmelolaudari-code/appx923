<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bateria ‚Äî Offline (Dashboard ‚Ä¢ Ritmistas ‚Ä¢ Calend√°rio)</title>
  <meta name="description" content="App offline sem Supabase, com dados em localStorage.">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root { --font: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
    body { font-family: var(--font); }
    .btn { padding: .5rem .75rem; border-radius: 1rem; font-size: .875rem; font-weight: 600; }
    .btn-ghost { border: 1px solid #e5e7eb; }
    .btn-ghost:hover { background: #f9fafb; }
    .btn-dark { background: #000; color: #fff; }
    .btn-dark:hover { background: #111827; }
    .btn-green { background: #16a34a; color: #fff; }
    .btn-green:hover { background: #22c55e; }
    .badge { display:inline-block; border-radius:.5rem; background:#f3f4f6; padding:.25rem .5rem; font-size:.75rem; font-weight:600; color:#374151; }
    .card { border-radius: 1rem; border: 1px solid #e5e7eb; background: #fff; padding: 1rem; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.45); display: none; align-items: center; justify-content: center; padding: 1rem; z-index: 50; }
    .modal { max-width: 720px; width: 100%; background: white; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,.15); }
    .link { text-decoration: underline; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <div id="app" class="mx-auto max-w-6xl px-4 py-6 space-y-4"></div>

  <!-- Modal: Criar Ensaio -->
  <div id="modal-add-ensaio" class="modal-backdrop">
    <div class="modal">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Novo Ensaio</h3>
        <button class="btn btn-ghost" data-close="#modal-add-ensaio">Fechar</button>
      </div>
      <div class="p-4 space-y-3">
        <label class="block">
          <span class="text-sm text-gray-500">Data do ensaio</span>
          <input id="add-data" type="date" class="mt-1 w-full rounded-2xl border px-3 py-2 text-sm">
        </label>
        <label class="block">
          <span class="text-sm text-gray-500">Observa√ß√µes</span>
          <textarea id="add-observacoes" class="mt-1 w-full h-24 rounded-2xl border px-3 py-2 text-sm" placeholder="Ex.: repert√≥rio, foco do dia‚Ä¶"></textarea>
        </label>
        <div class="block">
          <div class="text-sm text-gray-500 mb-1">Selecione os presentes</div>
          <div id="add-ritmistas" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-60 overflow-auto border rounded-2xl p-2"></div>
          <label class="flex items-center gap-2 mt-2 text-sm">
            <input id="add-mark-absent" type="checkbox" class="rounded" checked> Marcar demais como <b>AUSENTE</b>
          </label>
        </div>
      </div>
      <div class="p-4 border-t flex justify-end gap-2">
        <button class="btn btn-dark" id="btn-save-ensaio">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal: Gerenciar Presen√ßas de um Ensaio -->
  <div id="modal-presencas" class="modal-backdrop">
    <div class="modal">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Presen√ßas do Ensaio</h3>
        <button class="btn btn-ghost" data-close="#modal-presencas">Fechar</button>
      </div>
      <div class="p-4 space-y-3">
        <div class="text-sm text-gray-600" id="pres-ensaio-info">‚Äî</div>
        <div id="pres-list" class="grid grid-cols-1 sm:grid-cols-2 gap-2 max-h-72 overflow-auto border rounded-2xl p-2"></div>
        <label class="flex items-center gap-2 mt-2 text-sm">
          <input id="pres-mark-absent" type="checkbox" class="rounded" checked> Marcar n√£o selecionados como <b>AUSENTE</b>
        </label>
      </div>
      <div class="p-4 border-t flex justify-end gap-2">
        <button class="btn btn-dark" id="btn-save-presencas">Salvar</button>
      </div>
    </div>
  </div>


  <script>
    // ===== Supabase Init =====
    const SUPABASE_URL = "https://eauzqljvfbleavkrzouq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhdXpxbGp2ZmJsZWF2a3J6b3VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzQ1NTgsImV4cCI6MjA3MzY1MDU1OH0.iKyMJ3NUHwDBG4hhdrdHyrX-Of3IT_INuN3nBcocSpY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== Helpers de UI =====
    const $ = (sel, el=document) => el.querySelector(sel);
    const el = (t, c='', html='') => { const e=document.createElement(t); if(c) e.className=c; if(html) e.innerHTML=html; return e; };
    const fmtBR = iso => (iso && iso.length===10) ? iso.split('-').reverse().join('/') : iso;
    const todayISO = () => new Date().toISOString().slice(0,10);

    // ===== Armazenamento local (sem Supabase) =====
    const LS_RIT = 'bateria_ritmistas';
    const LS_ENS = 'bateria_ensaios';
    const LS_PRE = 'bateria_presencas';
    const LS_SEQ = 'bateria_seq'; // para IDs autoincrement

    const load = (k, fallback=[]) => { try { return JSON.parse(localStorage.getItem(k) || JSON.stringify(fallback)); } catch(_) { return fallback; } };
    const save = (k, v) => localStorage.setItem(k, JSON.stringify(v));
    const nextId = (table) => {
      const seq = load(LS_SEQ, {});
      seq[table] = (seq[table] || 0) + 1;
      save(LS_SEQ, seq);
      return String(seq[table]);
    };

    // Dados auxiliares locais (ranking/notas por ritmista)
    const RANK_KEY = 'ritmistas_rankings';
    const NOTES_KEY = 'ritmistas_notes';
    const loadLocal = (k) => { try { return JSON.parse(localStorage.getItem(k)||"{}"); } catch(_){ return {}; } };
    const saveLocal = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    let localRanks = loadLocal(RANK_KEY);
    let localNotes = loadLocal(NOTES_KEY);

    // ===== Seed inicial =====
    async function ensureSeed(){ /* no seed in Supabase mode */ }
        ];
        save(LS_RIT, rit);
        const seq = load(LS_SEQ, {}); seq['ritmistas'] = 36; save(LS_SEQ, seq);
      }
      if (ens.length === 0) {
        const id = '1';
        ens = [{ id, data: todayISO(), observacoes: 'Ensaio de estreia' }];
        save(LS_ENS, ens);
        const seq = load(LS_SEQ, {}); seq['ensaios'] = 1; save(LS_SEQ, seq);
        pre = [
          { ensaio_id: id, ritmista_id: '1', status: 'PRESENTE', observacoes: '' },
          { ensaio_id: id, ritmista_id: '2', status: 'PRESENTE', observacoes: '' },
          { ensaio_id: id, ritmista_id: '3', status: 'AUSENTE',  observacoes: '' },
        ];
        save(LS_PRE, pre);
      }
    }

    // ===== "DAO" local =====
    async function createRitmista(fields){
      const list = load(LS_RIT);
      const id = nextId('ritmistas');
      const row = { id, nome:'', apelido:'', telefone:'', camiseta:'', calca:'', sapato:'', ...fields };
      list.push(row); save(LS_RIT, list);
      return row;
    }
    
    async function updateRitmista(id, fields){
      const { error } = await supabase.from('ritmistas').update(fields).eq('id', id);
      if (error) { console.error(error); alert('Erro ao atualizar ritmista'); }
    }
    }
    async function deleteRitmista(id){
      const list = load(LS_RIT).filter(r => String(r.id) != String(id));
      save(LS_RIT, list);
      // remove presen√ßas relacionadas
      const pres = load(LS_PRE).filter(p => String(p.ritmista_id) != String(id));
      save(LS_PRE, pres);
      // tamb√©m limpa dados locais auxiliares
      delete localRanks[id]; saveLocal(RANK_KEY, localRanks);
      delete localNotes[id]; saveLocal(NOTES_KEY, localNotes);
    }
    
    async function listRitmistas(q=''){
      const sel = q ? supabase.from('ritmistas').select('*').ilike('nome', `%${q}%`) : supabase.from('ritmistas').select('*');
      const { data, error } = await sel.order('nome', { ascending: true });
      if (error) { console.error(error); return []; }
      return data || [];
    }
    
    async function getRitmista(id){
      const { data, error } = await supabase.from('ritmistas').select('*').eq('id', id).single();
      if (error) { console.error(error); return null; }
      return data;
    }
    
    async function listEnsaios(){
      const { data, error } = await supabase.from('ensaios').select('*').order('data', { ascending: false });
      if (error) { console.error(error); return []; }
      return data || [];
    }
    async function listEnsaiosByMonth(year, monthIdx){
      const start = new Date(Date.UTC(year, monthIdx, 1)).toISOString().slice(0,10);
      const end = new Date(Date.UTC(year, monthIdx+1, 1)).toISOString().slice(0,10);
      return load(LS_ENS).filter(e => e.data >= start && e.data < end).sort((a,b)=> (a.data||'').localeCompare(b.data||''));
    }
    
    async function listPresencasAll(){
      const { data, error } = await supabase.from('presencas').select('*');
      if (error) { console.error(error); return []; }
      return data || [];
    }
    
    async function listPresencasByEnsaio(ensaioId){
      const { data, error } = await supabase.from('presencas').select('*').eq('ensaio_id', ensaioId);
      if (error) { console.error(error); return []; }
      return data || [];
    }
    
    async function getEnsaio(id){
      const { data, error } = await supabase.from('ensaios').select('*').eq('id', id).single();
      if (error) { console.error(error); return null; }
      return data;
    }
    
    async function createEnsaio(dateISO, obs){
      const { data, error } = await supabase.from('ensaios').insert({ data: dateISO, observacoes: obs||'' }).select().single();
      if (error) { console.error(error); alert('Erro ao criar ensaio'); return null; }
      return data;
    }
    
    async function updateEnsaio(id, fields){
      const { error } = await supabase.from('ensaios').update(fields).eq('id', id);
      if (error) { console.error(error); alert('Erro ao atualizar ensaio'); }
    }
    }
    
    async function deleteEnsaio(id){
      let { error } = await supabase.from('presencas').delete().eq('ensaio_id', id);
      if (error) { console.error(error); alert('Erro removendo presen√ßas'); }
      const { error: e2 } = await supabase.from('ensaios').delete().eq('id', id);
      if (e2) { console.error(e2); alert('Erro removendo ensaio'); }
    }

    
    async function setPresencasForEnsaio(ensaioId, selectedIds, markAbsent=true){
      // Apaga presen√ßas antigas do ensaio
      let { error } = await supabase.from('presencas').delete().eq('ensaio_id', ensaioId);
      if (error) { console.error(error); alert('Erro limpando presen√ßas'); return; }
      // Reinsere conforme sele√ß√£o
      const ritRows = await listRitmistas();
      const allIds = ritRows.map(r => String(r.id));
      const rows = [];
      allIds.forEach(id => {
        if (selectedIds.includes(String(id))) rows.push({ ensaio_id: ensaioId, ritmista_id: id, status: 'PRESENTE', observacoes: '' });
        else if (markAbsent) rows.push({ ensaio_id: ensaioId, ritmista_id: id, status: 'AUSENTE', observacoes: '' });
      });
      if (rows.length){
        const res = await supabase.from('presencas').insert(rows);
        if (res.error) { console.error(res.error); alert('Erro salvando presen√ßas'); }
      }
    }

    // ===== Topbar =====
    function topbar(active='dashboard') {
      const wrap = el('div','flex items-center justify-between');
      const left = el('div','flex items-center gap-3','<a href="#dashboard" class="h-9 w-9 rounded-xl bg-black text-white flex items-center justify-center font-bold">B</a><h1 class="text-lg md:text-2xl font-semibold">Bateria</h1>');
      const nav  = el('nav','flex gap-2');
      const mk = (hash,label) => {
        const a = el('a','btn '+(active===hash?'btn-dark':'btn-ghost'),label); a.href = '#'+hash; return a;
      };
      nav.append(mk('dashboard','Dashboard'), mk('ritmistas','Ritmistas'), mk('calendario','Ensaios'), mk('backup','Backup'));
      wrap.append(left, nav);
      return wrap;
    }

    // ===== DASHBOARD =====
    async function pageDashboard() {
      const root = $('#app'); root.innerHTML = '';
      root.append(topbar('dashboard'));

      const cards = el('div','grid grid-cols-1 md:grid-cols-3 gap-4 mt-4');
      const card = (title,val,desc='') => {
        const c=el('div','card');
        c.innerHTML = `<div class="text-sm text-gray-500">${title}</div><div class="text-3xl font-extrabold">${val}</div><div class="text-xs text-gray-500 mt-1">${desc}</div>`;
        return c;
      };
      root.append(cards);

      const [ensaios, pres] = await Promise.all([listEnsaios(), listPresencasAll()]);
      const countsByEnsaio = new Map();
      pres.forEach(p => {
        const c = countsByEnsaio.get(p.ensaio_id) || {PRESENTE:0,AUSENTE:0,JUSTIFICADA:0};
        if (p.status in c) c[p.status]++;
        countsByEnsaio.set(p.ensaio_id, c);
      });
      const n = ensaios.length || 1;
      let sumP=0, sumA=0;
      ensaios.forEach(e => { const c=countsByEnsaio.get(e.id)||{PRESENTE:0,AUSENTE:0,JUSTIFICADA:0}; sumP+=c.PRESENTE; sumA+=c.AUSENTE; });
      cards.append(card('M√©dia de Presen√ßas / Ensaio', (sumP/n).toFixed(1), 'Qtde de presentes por ensaio'),
                   card('M√©dia de Aus√™ncias / Ensaio', (sumA/n).toFixed(1), 'Qtde de ausentes por ensaio'),
                   card('Total de Ensaios', ensaios.length, 'Em ordem decrescente'));

      const listCard = el('div','card mt-2');
      listCard.innerHTML = `<div class="mb-3 flex items-center justify-between"><h3 class="text-lg font-semibold">Ensaios</h3><span class="text-sm text-gray-500">Clique para entrar</span></div>`;
      const tableWrap = el('div','overflow-auto rounded-xl border');
      const table = el('table','min-w-full text-sm');
      table.innerHTML = '<thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">Data</th><th class="px-3 py-2 text-left">Presentes</th><th class="px-3 py-2 text-left">Ausentes</th><th class="px-3 py-2 text-left">Justificadas</th><th class="px-3 py-2 text-left">A√ß√µes</th></tr></thead><tbody></tbody>';
      const tbody = $('tbody', table);
      if (!ensaios.length) { tbody.innerHTML='<tr><td colspan="5" class="px-3 py-6 text-center text-gray-500">Sem ensaios.</td></tr>'; }
      else ensaios.forEach(e => {
        const c = countsByEnsaio.get(e.id) || {PRESENTE:0,AUSENTE:0,JUSTIFICADA:0};
        const tr = el('tr','odd:bg-white even:bg-gray-50',`<td class="px-3 py-2">${fmtBR(e.data)}</td>
          <td class="px-3 py-2">${c.PRESENTE}</td><td class="px-3 py-2">${c.AUSENTE}</td><td class="px-3 py-2">${c.JUSTIFICADA}</td>
          <td class="px-3 py-2"><a class="btn btn-dark" href="#ensaio:${e.id}">Entrar</a></td>`);
        tbody.append(tr);
      });
      tableWrap.append(table); listCard.append(tableWrap); root.append(listCard);
    }

    // ===== RITMISTAS =====
    let rit_current=[], isTable=false;
    async function pageRitmistas() {
      const root = $('#app'); root.innerHTML='';
      root.append(topbar('ritmistas'));

      const bar = el('div','flex items-center justify-between mt-4');
      bar.append(el('h2','text-xl font-semibold','Ritmistas'), el('div','flex flex-wrap items-center gap-2',
        '<button id="btn-import" class="btn btn-ghost">Importar CSV</button><button id="btn-export" class="btn btn-ghost">Exportar CSV</button><button id="btn-toggle-view" class="btn btn-ghost">Tabela</button><button id="btn-add" class="btn btn-green">+ Adicionar Ritmista</button>'
      ));
      root.append(bar);

      const filters = el('div','card mt-2',`
        <div class="grid grid-cols-1 gap-3 md:grid-cols-5">
          <label class="block md:col-span-2">
            <span class="text-sm text-gray-500">Buscar por nome/apelido</span>
            <div class="mt-1 flex items-center gap-2 rounded-xl border px-3 py-2">
              <span>üîé</span><input id="q" class="w-full outline-none text-sm" placeholder="Buscar por nome ou apelido‚Ä¶">
            </div>
          </label>
          <label class="block"><span class="text-sm text-gray-500">Ranking</span>
            <select id="f-ranking" class="mt-1 w-full rounded-2xl border px-3 py-2 text-sm">
              <option value="">Todos</option><option>A+</option><option>A</option><option>B+</option><option>B</option><option>C</option>
            </select>
          </label>
          <label class="block"><span class="text-sm text-gray-500">Camiseta</span>
            <input id="f-camiseta" class="mt-1 w-full rounded-2xl border px-3 py-2 text-sm" placeholder="Ex.: P, M, G">
          </label>
          <label class="block"><span class="text-sm text-gray-500">Cal√ßa / Sapato</span>
            <div class="mt-1 grid grid-cols-2 gap-2">
              <input id="f-calca" class="rounded-2xl border px-3 py-2 text-sm" placeholder="Ex.: 42">
              <input id="f-sapato" class="rounded-2xl border px-3 py-2 text-sm" placeholder="Ex.: 40">
            </div>
          </label>
        </div>
      `);
      root.append(filters);

      const cardsSec = el('section','','<div id="view-cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>');
      const tableSec = el('section','hidden overflow-auto rounded-2xl border bg-white','<table class="min-w-full text-sm"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">Nome</th><th class="px-3 py-2 text-left">Apelido</th><th class="px-3 py-2 text-left">Telefone</th><th class="px-3 py-2 text-left">Camiseta</th><th class="px-3 py-2 text-left">Cal√ßa</th><th class="px-3 py-2 text-left">Sapato</th><th class="px-3 py-2 text-left">Ranking</th><th class="px-3 py-2 text-left">A√ß√µes</th></tr></thead><tbody id="table-body"></tbody></table>');
      root.append(cardsSec, tableSec);

      const setView = (tableMode) => {
        isTable = tableMode;
        if (isTable) { cardsSec.classList.add('hidden'); tableSec.classList.remove('hidden'); $('#btn-toggle-view').textContent='Cards'; renderTable(rit_current); }
        else { tableSec.classList.add('hidden'); cardsSec.classList.remove('hidden'); $('#btn-toggle-view').textContent='Tabela'; renderCards(rit_current); }
      };
      const applyFilters = (rows) => {
        const q = $('#q').value.trim().toLowerCase();
        const fr = $('#f-ranking').value;
        const fc = $('#f-camiseta').value.trim().toLowerCase();
        const fcal = $('#f-calca').value.trim().toLowerCase();
        const fs = $('#f-sapato').value.trim().toLowerCase();
        return rows.filter(r => {
          const matchQ = !q || (r.nome||'').toLowerCase().includes(q) || (r.apelido||'').toLowerCase().includes(q);
          const rank = localRanks[r.id] || '';
          const matchR = !fr || rank === fr;
          const matchCam = !fc || String(r.camiseta||'').toLowerCase() === fc;
          const matchCal = !fcal || String(r.calca||'').toLowerCase() === fcal;
          const matchSap = !fs || String(r.sapato||'').toLowerCase() === fs;
          return matchQ && matchR && matchCam && matchCal && matchSap;
        });
      };
      const renderCards = (rows) => {
        const wrap = $('#view-cards'); wrap.innerHTML='';
        const filtered = applyFilters(rows);
        if(!filtered.length){ wrap.innerHTML='<div class="col-span-full card text-center text-gray-500">Sem ritmistas com esses filtros.</div>'; return; }
        filtered.forEach(r => {
          const rank = localRanks[r.id]||'';
          const card = el('div','card',`
            <div class="flex items-start justify-between">
              <div class="flex items-center gap-2">
                <div class="h-9 w-9 rounded-xl bg-amber-100 text-amber-800 flex items-center justify-center">üë§</div>
                <div><a class="font-semibold link" href="#ritmista:${r.id}">${r.nome||'-'}</a><div class="text-sm text-gray-500">${r.apelido?('‚Äú'+r.apelido+'‚Äù'):'&nbsp;'}</div></div>
              </div>
              <div class="flex gap-2 text-gray-500">
                <button class="btn btn-ghost text-xs" data-edit="${r.id}">‚úèÔ∏è Editar</button>
                <button class="btn btn-ghost text-xs" data-del="${r.id}">üóëÔ∏è Apagar</button>
              </div>
            </div>
            <div class="mt-3 grid grid-cols-1 gap-2 text-sm text-gray-700">
              <div>Telefone: <span class="font-medium">${r.telefone||'-'}</span></div>
              <div class="flex flex-wrap gap-2">
                <span class="badge">Camiseta: ${r.camiseta||'-'}</span>
                <span class="badge">Cal√ßa: ${r.calca||'-'}</span>
                <span class="badge">Sapato: ${r.sapato||'-'}</span>
              </div>
            </div>
            <div class="mt-3 flex items-center justify-between">
              <label class="text-sm text-gray-600 flex items-center gap-2">
                <span>Ranking:</span>
                <select data-rank="${r.id}" class="rounded-2xl border px-2 py-1 text-sm">
                  <option value="" ${rank===''?'selected':''}>‚Äî</option>
                  <option${rank==='A+'?' selected':''}>A+</option><option${rank==='A'?' selected':''}>A</option>
                  <option${rank==='B+'?' selected':''}>B+</option><option${rank==='B'?' selected':''}>B</option><option${rank==='C'?' selected':''}>C</option>
                </select>
              </label>
              <a class="btn btn-ghost" href="#ritmista:${r.id}">Ver perfil</a>
            </div>`);
          wrap.append(card);
        });
        wrap.querySelectorAll('select[data-rank]').forEach(sel => sel.addEventListener('change', e=>{ const id=e.target.dataset.rank; localRanks[id]=e.target.value||''; saveLocal(RANK_KEY, localRanks);}));
        // Edit/Delete handlers
        wrap.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-edit');
          const r = await getRitmista(id);
          if (!r) return alert('Ritmista n√£o encontrado.');
          // prompts simples para edi√ß√£o
          const nome = prompt('Nome', r.nome||''); if (nome===null) return;
          const apelido = prompt('Apelido', r.apelido||''); if (apelido===null) return;
          const telefone = prompt('Telefone', r.telefone||''); if (telefone===null) return;
          const camiseta = prompt('Camiseta (P/M/G...)', r.camiseta||''); if (camiseta===null) return;
          const calca = prompt('Cal√ßa', r.calca||''); if (calca===null) return;
          const sapato = prompt('Sapato', r.sapato||''); if (sapato===null) return;
          await updateRitmista(id, { nome, apelido, telefone, camiseta, calca, sapato });
          rit_current = await listRitmistas();
          // re-render mantendo modo atual
          (isTable ? renderTable : renderCards)(rit_current);
        }));
        wrap.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-del');
          const r = await getRitmista(id);
          if (!r) return;
          if (!confirm('Apagar o ritmista "'+(r.nome||id)+'"? Esta a√ß√£o remove tamb√©m suas presen√ßas.')) return;
          await deleteRitmista(id);
          rit_current = await listRitmistas();
          (isTable ? renderTable : renderCards)(rit_current);
        }));

      };
      const renderTable = (rows) => {
        const tbody = $('#table-body'); tbody.innerHTML='';
        const filtered = applyFilters(rows);
        if(!filtered.length){ tbody.innerHTML='<tr><td colspan="8" class="px-3 py-6 text-center text-gray-500">Sem ritmistas com esses filtros.</td></tr>'; return; }
        filtered.forEach(r => {
          const rank = localRanks[r.id]||'';
          const tr = el('tr','odd:bg-white even:bg-gray-50',`
            <td class="px-3 py-2"><a class="link" href="#ritmista:${r.id}">${r.nome||'-'}</a></td>
            <td class="px-3 py-2">${r.apelido||'-'}</td><td class="px-3 py-2">${r.telefone||'-'}</td>
            <td class="px-3 py-2">${r.camiseta||'-'}</td><td class="px-3 py-2">${r.calca||'-'}</td><td class="px-3 py-2">${r.sapato||'-'}</td>
            <td class="px-3 py-2"><select data-rank="${r.id}" class="rounded-2xl border px-2 py-1 text-sm">
              <option value="" ${rank===''?'selected':''}>‚Äî</option><option${rank==='A+'?' selected':''}>A+</option><option${rank==='A'?' selected':''}>A</option>
              <option${rank==='B+'?' selected':''}>B+</option><option${rank==='B'?' selected':''}>B</option><option${rank==='C'?' selected':''}>C</option>
            </select></td>
            <td class="px-3 py-2 flex gap-2"><a class="btn btn-ghost text-xs" href="#ritmista:${r.id}">Abrir</a><button class="btn btn-ghost text-xs" data-edit="${r.id}">Editar</button><button class="btn btn-ghost text-xs" data-del="${r.id}">Apagar</button></td>`);
          tbody.append(tr);
        });
        tbody.querySelectorAll('select[data-rank]').forEach(sel => sel.addEventListener('change', e=>{ const id=e.target.dataset.rank; localRanks[id]=e.target.value||''; saveLocal(RANK_KEY, localRanks);}));
        tbody.querySelectorAll('[data-edit]').forEach(btn => btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-edit');
          const r = await getRitmista(id);
          if (!r) return alert('Ritmista n√£o encontrado.');
          const nome = prompt('Nome', r.nome||''); if (nome===null) return;
          const apelido = prompt('Apelido', r.apelido||''); if (apelido===null) return;
          const telefone = prompt('Telefone', r.telefone||''); if (telefone===null) return;
          const camiseta = prompt('Camiseta (P/M/G...)', r.camiseta||''); if (camiseta===null) return;
          const calca = prompt('Cal√ßa', r.calca||''); if (calca===null) return;
          const sapato = prompt('Sapato', r.sapato||''); if (sapato===null) return;
          await updateRitmista(id, { nome, apelido, telefone, camiseta, calca, sapato });
          rit_current = await listRitmistas();
          renderTable(rit_current);
        }));
        tbody.querySelectorAll('[data-del]').forEach(btn => btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.getAttribute('data-del');
          const r = await getRitmista(id);
          if (!r) return;
          if (!confirm('Apagar o ritmista "'+(r.nome||id)+'"? Esta a√ß√£o remove tamb√©m suas presen√ßas.')) return;
          await deleteRitmista(id);
          rit_current = await listRitmistas();
          renderTable(rit_current);
        }));

      };

      const toCSV = (rows) => {
        const headers = ['id','nome','apelido','telefone','camiseta','calca','sapato'];
        const esc = (v) => { if(v==null) return ''; const s=String(v); return (s.includes('"')||s.includes(',')||s.includes('\n'))?('"'+s.replace(/"/g,'""')+'"'):s; };
        return [headers.join(',')].concat(rows.map(r => headers.map(h=>esc(r[h]||'')).join(','))).join('\n');
      };
      const download = (name, txt) => { const blob=new Blob([txt], {type:'text/csv'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url); };

      $('#btn-toggle-view').addEventListener('click', ()=> setView(!isTable));
      $('#btn-export').addEventListener('click', ()=> download('ritmistas.csv', toCSV(rit_current)));
      $('#btn-import').addEventListener('click', async ()=> {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.xlsx,.xls,.csv';
        input.onchange = async (e)=>{
          const file = e.target.files && e.target.files[0];
          if (!file) return;
          const buf = await file.arrayBuffer();

          const normalizeRows = (arr) => {
            const normKey = (k) => String(k||'').trim().toLowerCase();
            return arr.map(obj => {
              const m = {}; Object.keys(obj||{}).forEach(k => { m[normKey(k)] = obj[k]; });
              let id = (m['id']!==undefined && m['id']!=='') ? String(m['id']) : '';
              if (!id) id = nextId('ritmistas');
              return {
                id,
                nome: m['nome']||'',
                apelido: m['apelido']||'',
                telefone: m['telefone']||'',
                camiseta: m['camiseta']||'',
                calca: m['calca']||'',
                sapato: m['sapato']||'',
              };
            });
          };

          let rows = [];
          const fname = (file.name||'').toLowerCase();
          try {
            if (fname.endsWith('.xlsx') || fname.endsWith('.xls')) {
              const wb = XLSX.read(buf, { type: 'array' });
              const ws = wb.Sheets[wb.SheetNames[0]];
              const json = XLSX.utils.sheet_to_json(ws, { defval: '' });
              rows = normalizeRows(json);
            } else {
              // CSV parse (simple)
              const text = new TextDecoder().decode(new Uint8Array(buf));
              const lines = text.split(/\r?\n/).filter(Boolean);
              if (lines.length === 0) { alert('CSV vazio'); return; }
              const header = lines.shift();
              const cols = header.split(',').map(s=>s.trim());
              const idx = (name) => cols.findIndex(c => c.toLowerCase() === name);
              rows = lines.map(line => {
                // parse simples (sem aspas com v√≠rgula interna)
                const parts = line.split(',');
                const get = (name) => parts[idx(name)]||'';
                let id = get('id'); if (!id) id = nextId('ritmistas');
                return {
                  id,
                  nome: get('nome'),
                  apelido: get('apelido'),
                  telefone: get('telefone'),
                  camiseta: get('camiseta'),
                  calca: get('calca'),
                  sapato: get('sapato'),
                };
              });
            }
          } catch (err) {
            console.error(err);
            alert('Falha ao ler o arquivo. Verifique o formato.');
            return;
          }

          // Salva e ajusta o seq para continuar autoincrement corretamente
          save(LS_RIT, rows);
          const maxId = rows.reduce((m,r)=> Math.max(m, parseInt(r.id||0,10)||0), 0);
          const seq = load(LS_SEQ, {}); seq['ritmistas'] = Math.max(seq['ritmistas']||0, maxId); save(LS_SEQ, seq);

          rit_current = await listRitmistas();
          setView(isTable);
          alert('Importado!');
        };
        input.click();
      });
      $('#btn-add').addEventListener('click', ()=> {
        const nome = prompt('Nome do ritmista');
        if (!nome) return;
        const novo = { id: nextId('ritmistas'), nome, apelido: '', telefone: '', camiseta: '', calca: '', sapato: '' };
        const cur = load(LS_RIT); cur.push(novo); save(LS_RIT, cur);
        rit_current = cur.slice();
        setView(isTable);
      });
      ['#q','#f-ranking','#f-camiseta','#f-calca','#f-sapato'].forEach(s => {
        $(s).addEventListener('input', ()=> setView(isTable));
        $(s).addEventListener('change', ()=> setView(isTable));
      });

      rit_current = await listRitmistas();
      setView(false);
    }

    // ===== Perfil do Ritmista =====
    async function pageRitmistaDetail(id) {
      const root = $('#app'); root.innerHTML='';
      root.append(topbar('ritmistas'));

      const rit = await getRitmista(id);
      const pres = (await listPresencasAll()).filter(p => String(p.ritmista_id) === String(id));
      if (!rit || !rit.id) { root.append(el('div','p-6 text-red-600','Ritmista n√£o encontrado.')); return; }

      const total = pres.length;
      const c = pres.reduce((acc,p)=> (acc[p.status]=(acc[p.status]||0)+1, acc), {});
      const freq = total ? ((c['PRESENTE']||0)/total*100).toFixed(1)+'%' : '‚Äî';
      const aus = total ? ((c['AUSENTE']||0)/total*100).toFixed(1)+'%' : '‚Äî';
      const jus = total ? ((c['JUSTIFICADA']||0)/total*100).toFixed(1)+'%' : '‚Äî';

      const head = el('div','flex items-center justify-between mt-4');
      head.append(el('div','flex items-center gap-3',`
        <div class="h-9 w-9 rounded-xl bg-amber-100 text-amber-800 flex items-center justify-center">üë§</div>
        <div>
          <div class="text-xl font-semibold">${rit.nome||'-'}</div>
          <div class="text-sm text-gray-500">${rit.apelido?('‚Äú'+rit.apelido+'‚Äù'):'&nbsp;'}</div>
        </div>`));
      head.append(el('div','flex gap-2', `<a href="#ritmistas" class="btn btn-ghost">Voltar</a>`));
      root.append(head);

      const cards = el('div','grid grid-cols-1 md:grid-cols-4 gap-4 mt-4');
      const card = (t,v,d='') => { const c=el('div','card'); c.innerHTML=`<div class="text-sm text-gray-500">${t}</div><div class="text-2xl font-extrabold">${v}</div><div class="text-xs text-gray-500 mt-1">${d}</div>`; return c; };
      cards.append(card('M√©dia de Frequ√™ncia', freq, 'Presen√ßas / total'),
                   card('M√©dia de Aus√™ncia', aus, 'Aus√™ncias / total'),
                   card('Justificadas', jus, 'Propor√ß√£o'),
                   card('Total de Ensaios', total, 'Com registro de presen√ßa'));
      root.append(cards);

      const cardInfo = el('div','card');
      const rank = localRanks[rit.id] || '';
      cardInfo.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div><div class="text-sm text-gray-500">Telefone</div><div class="font-medium">${rit.telefone||'-'}</div></div>
          <div><div class="text-sm text-gray-500">Camiseta</div><div class="font-medium">${rit.camiseta||'-'}</div></div>
          <div><div class="text-sm text-gray-500">Cal√ßa</div><div class="font-medium">${rit.calca||'-'}</div></div>
          <div><div class="text-sm text-gray-500">Sapato</div><div class="font-medium">${rit.sapato||'-'}</div></div>
        </div>
        <div class="mt-4 flex items-center gap-2">
          <div class="text-sm text-gray-500">Ranking:</div>
          <select id="rank-select" class="rounded-2xl border px-2 py-1 text-sm">
            <option value="" ${rank===''?'selected':''}>‚Äî</option>
            <option${rank==='A+'?' selected':''}>A+</option><option${rank==='A'?' selected':''}>A</option>
            <option${rank==='B+'?' selected':''}>B+</option><option${rank==='B'?' selected':''}>B</option><option${rank==='C'?' selected':''}>C</option>
          </select>
          <span class="text-xs text-gray-500">(* salvo no navegador)</span>
        </div>`;
      root.append(cardInfo);
      $('#rank-select').addEventListener('change', (e)=> { localRanks[rit.id]=e.target.value||''; saveLocal(RANK_KEY, localRanks);} );

      const notesCard = el('div','card');
      notesCard.innerHTML = `
        <div class="mb-2 text-lg font-semibold">Anota√ß√µes</div>
        <textarea id="notes-text" class="w-full h-40 rounded-2xl border px-3 py-2 text-sm" placeholder="Observa√ß√µes‚Ä¶"></textarea>
        <div class="mt-2 flex justify-end">
          <button id="save-notes" class="btn btn-dark">Salvar</button>
        </div>`;
      root.append(notesCard);
      $('#notes-text').value = localNotes[rit.id] || '';
      $('#save-notes').addEventListener('click', ()=>{ localNotes[rit.id] = $('#notes-text').value||''; saveLocal(NOTES_KEY, localNotes); alert('Anota√ß√£o salva!'); });

      const hist = el('div','card');
      hist.innerHTML = '<div class="text-lg font-semibold mb-2">Hist√≥rico de presen√ßas</div>';
      const table = el('table','min-w-full text-sm');
      table.innerHTML = '<thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">Data</th><th class="px-3 py-2 text-left">Status</th><th class="px-3 py-2 text-left">Obs.</th></tr></thead><tbody></tbody>';
      const tbody = $('tbody', table);
      if (pres.length===0) tbody.innerHTML = '<tr><td colspan="3" class="px-3 py-6 text-center text-gray-500">Sem registros.</td></tr>';
      else {
        const ensList = await listEnsaios();
        const dateMap = new Map((ensList||[]).map(e=>[String(e.id), e.data]));
        pres.sort((a,b)=> (dateMap.get(String(b.ensaio_id))||'').localeCompare(dateMap.get(String(a.ensaio_id))||''));
        pres.forEach(p => tbody.append(el('tr','odd:bg-white even:bg-gray-50',`
          <td class="px-3 py-2">${fmtBR(dateMap.get(String(p.ensaio_id)) || '‚Äî')}</td>
          <td class="px-3 py-2">${p.status}</td>
          <td class="px-3 py-2">${p.observacoes || '‚Äî'}</td>`)));
      }
      hist.append(table); root.append(hist);
    }

    // ===== Calend√°rio com CRUD de ensaio =====
    
    async function pageCalendario() {
      const root = $('#app'); root.innerHTML=''; root.append(topbar('calendario'));
      const wrap = el('div','mt-4 space-y-4');
      const header = el('div','flex items-center justify-between');
      header.append(el('h2','text-xl font-semibold','Ensaios'),
                    el('button','btn btn-green','+ Adicionar Ensaio'));
      wrap.append(header);

      const listContainer = el('div','space-y-2','');
      wrap.append(listContainer);
      root.append(wrap);

      const renderList = async () => {
        const ensaios = await listEnsaios();
        listContainer.innerHTML='';
        if (!ensaios.length){
          listContainer.innerHTML='<div class="card text-gray-500 text-center p-4">Nenhum ensaio cadastrado.</div>';
        } else {
          ensaios.forEach(async e => {
            const pres = await listPresencasByEnsaio(e.id);
            const counts = pres.reduce((acc,p)=> (acc[p.status]=(acc[p.status]||0)+1, acc), {});
            const row = el('div','card flex items-center justify-between',
              `<div><div class="font-semibold">${fmtBR(e.data)}</div><div class="text-xs text-gray-500">${e.observacoes||'‚Äî'}</div></div>
               <div class="text-xs flex gap-2">
                 <span class="badge">P ${counts['PRESENTE']||0}</span>
                 <span class="badge">A ${counts['AUSENTE']||0}</span>
                 <span class="badge">J ${counts['JUSTIFICADA']||0}</span>
                 <a class="btn btn-dark ml-2" href="#ensaio:${e.id}">Entrar</a><button class="btn btn-ghost ml-2 text-xs" data-edit-ensaio="${e.id}">Editar</button><button class="btn btn-ghost ml-2 text-xs" data-del-ensaio="${e.id}">Excluir</button>
               </div>`);
            listContainer.append(row);
            row.querySelectorAll('[data-edit-ensaio]').forEach(btn => btn.addEventListener('click', async (ev)=>{
              const id = ev.currentTarget.getAttribute('data-edit-ensaio');
              // simple prompts to edit date/obs
              const ens = await getEnsaio(id);
              if (!ens) return;
              const data = prompt('Data do ensaio (AAAA-MM-DD):', ens.data||'') || ens.data;
              const obs = prompt('Observa√ß√µes:', ens.observacoes||'') ?? ens.observacoes;
              await updateEnsaio(id, { data, observacoes: obs });
              renderList();
            }));
            row.querySelectorAll('[data-del-ensaio]').forEach(btn => btn.addEventListener('click', async (ev)=>{
              const id = ev.currentTarget.getAttribute('data-del-ensaio');
              if (confirm('Excluir este ensaio?')){
                await deleteEnsaio(id);
                renderList();
              }
            }));
          });
        }
      };

      // Add Ensaio button
      header.querySelector('button').addEventListener('click', async ()=>{
        await renderAddModal();
        $('#modal-add-ensaio').style.display='flex';
      });
      document.querySelectorAll('[data-close]').forEach(btn => btn.addEventListener('click', (e)=>{ $(e.target.getAttribute('data-close')).style.display='none'; }));

      renderList();
    }
    async function renderAddModal(){
      $('#add-data').value = todayISO();
      $('#add-observacoes').value = '';
      $('#add-mark-absent').checked = true;
      const wrap = $('#add-ritmistas'); wrap.innerHTML='Carregando‚Ä¶';
      const rit = await listRitmistas();
      wrap.innerHTML='';
      (rit||[]).forEach(r => {
        const row = el('label','flex items-center gap-2 border rounded-xl px-3 py-2 text-sm');
        row.innerHTML = `<input type="checkbox" value="${r.id}" class="rounded"> <span class="font-medium">${r.nome}</span> <span class="text-gray-500">(${r.apelido||'‚Äî'})</span>`;
        wrap.append(row);
      });
      $('#btn-save-ensaio').onclick = async ()=> {
        const date = $('#add-data').value || todayISO();
        const obs = $('#add-observacoes').value || '';
        const markAbsent = $('#add-mark-absent').checked;
        const selected = Array.from(wrap.querySelectorAll('input[type="checkbox"]:checked')).map(c=>String(c.value));
        const ens = await createEnsaio(date, obs);
        await setPresencasForEnsaio(ens.id, selected, markAbsent);
        $('#modal-add-ensaio').style.display='none';
        location.hash = '#ensaio:'+ens.id;
      };
    }

    // ===== P√°gina do Ensaio =====
    async function pageEnsaioDetail(id){
      const root = $('#app'); root.innerHTML=''; root.append(topbar()); // sem highlight espec√≠fico
      const ens = await getEnsaio(id);
      if (!ens) { root.append(el('div','p-6 text-red-600','Ensaio n√£o encontrado.')); return; }
      const pres = await listPresencasByEnsaio(id);

      const counts = pres.reduce((acc,p)=> (acc[p.status]=(acc[p.status]||0)+1, acc), {});
      const total = pres.length || 1;

      const head = el('div','flex items-center justify-between mt-2');
      head.append(el('div','',`<div class="text-xl font-semibold">Ensaio ‚Äî ${fmtBR(ens.data)}</div><div class="text-sm text-gray-500">${ens.observacoes||'‚Äî'}</div>`));
      const actions = el('div','flex gap-2');
      const btnEditPres = el('button','btn btn-ghost','Gerenciar Presen√ßas');
      const btnVoltar = el('a','btn btn-ghost','Voltar'); btnVoltar.href='#calendario';
      actions.append(btnEditPres, btnVoltar); head.append(actions);
      root.append(head);

      const cards = el('div','grid grid-cols-1 md:grid-cols-4 gap-4 mt-4');
      const card = (t,v,d='') => { const c=el('div','card'); c.innerHTML=`<div class="text-sm text-gray-500">${t}</div><div class="text-2xl font-extrabold">${v}</div><div class="text-xs text-gray-500 mt-1">${d}</div>`; return c; };
      cards.append(card('Presentes', counts['PRESENTE']||0, 'Qtde no dia'),
                   card('Ausentes', counts['AUSENTE']||0, 'Qtde no dia'),
                   card('Justificadas', counts['JUSTIFICADA']||0, 'Qtde no dia'),
                   card('Total registros', total, 'Presen√ßas cadastradas'));
      root.append(cards);

      const notes = el('div','card mt-2');
      notes.innerHTML = `<div class="flex items-center justify-between mb-2"><div class="text-lg font-semibold">Anota√ß√µes do Ensaio</div><button id="save-nota" class="btn btn-dark">Salvar</button></div>
                         <textarea id="nota-text" class="w-full h-28 rounded-2xl border px-3 py-2 text-sm" placeholder="Observa√ß√µes do ensaio‚Ä¶"></textarea>`;
      root.append(notes);
      $('#nota-text').value = ens.observacoes || '';
      $('#save-nota').onclick = async ()=> {
        const txt = $('#nota-text').value || '';
        await updateEnsaio(id, { observacoes: txt });
        alert('Anota√ß√µes salvas!');
      };

      const rit = await listRitmistas();
      const map = new Map((rit||[]).map(r=>[String(r.id), r.nome]));
      const box = el('div','card mt-2'); box.innerHTML = '<div class="text-lg font-semibold mb-2">Presen√ßas</div>';
      const table = el('table','min-w-full text-sm');
      table.innerHTML = '<thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">Ritmista</th><th class="px-3 py-2 text-left">Status</th><th class="px-3 py-2 text-left">Obs.</th></tr></thead><tbody></tbody>';
      const tbody = $('tbody', table);
      if (!pres.length) tbody.innerHTML = '<tr><td colspan="3" class="px-3 py-6 text-center text-gray-500">Sem presen√ßas cadastradas.</td></tr>';
      else pres.forEach(p => tbody.append(el('tr','odd:bg-white even:bg-gray-50',`<td class="px-3 py-2"><a class="link" href="#ritmista:${p.ritmista_id}">${map.get(String(p.ritmista_id))||p.ritmista_id}</a></td><td class="px-3 py-2">${p.status}</td><td class="px-3 py-2">${p.observacoes||'‚Äî'}</td>`)));
      box.append(table); root.append(box);

      btnEditPres.addEventListener('click', async ()=>{ await openManagePresencasModal(id, ens); });
    }

    // Modal Gerenciar Presen√ßas
    async function openManagePresencasModal(ensaioId, ens){
      $('#pres-ensaio-info').textContent = `Data ${fmtBR(ens.data)} ‚Äî selecione quem esteve PRESENTE`;
      const wrap = $('#pres-list'); wrap.innerHTML = 'Carregando‚Ä¶';
      const [rit, pres] = await Promise.all([ listRitmistas(), listPresencasByEnsaio(ensaioId) ]);
      wrap.innerHTML = '';
      const presentSet = new Set(pres.filter(p=>p.status==='PRESENTE').map(p=>String(p.ritmista_id)));
      (rit||[]).forEach(r => {
        const row = el('label','flex items-center gap-2 border rounded-xl px-3 py-2 text-sm');
        row.innerHTML = `<input type="checkbox" value="${r.id}" ${presentSet.has(String(r.id))?'checked':''} class="rounded"> <span class="font-medium">${r.nome}</span> <span class="text-gray-500">(${r.apelido||'‚Äî'})</span>`;
        wrap.append(row);
      });
      $('#pres-mark-absent').checked = true;
      $('#modal-presencas').style.display = 'flex';

      $('#btn-save-presencas').onclick = async ()=> {
        const selected = Array.from(wrap.querySelectorAll('input[type="checkbox"]:checked')).map(c=>String(c.value));
        const markAbsent = $('#pres-mark-absent').checked;
        await setPresencasForEnsaio(ensaioId, selected, markAbsent);
        $('#modal-presencas').style.display = 'none';
        location.hash = '#ensaio:'+ensaioId;
      };
    }


    async function pageBackup(){
      const root = $('#app'); root.innerHTML=''; root.append(topbar('backup'));
      const wrap = el('div','mt-4 space-y-4');
      const card = el('div','card');
      card.innerHTML = `
        <div class="mb-2">
          <div class="text-lg font-semibold">Backup & Restaura√ß√£o</div>
          <div class="text-sm text-gray-500">Exporte um arquivo .json com todos os dados e importe em outro dispositivo.</div>
        </div>
        <div class="flex flex-wrap items-center gap-2">
          <button id="btn-backup" class="btn btn-dark">Gerar arquivo de backup (.json)</button>
          <label class="btn btn-ghost cursor-pointer">
            Importar backup (.json)
            <input id="file-restore" type="file" accept=".json" class="hidden">
          </label>
        </div>
        <div class="mt-3 text-xs text-gray-500">
          O backup inclui: ritmistas, ensaios, presen√ßas, rankings locais, anota√ß√µes e sequ√™ncia de IDs.
        </div>`;
      wrap.append(card);
      root.append(wrap);

      const exportData = async () => {
        const { data: r } = await supabase.from('ritmistas').select('*');
        const { data: e } = await supabase.from('ensaios').select('*');
        const { data: p } = await supabase.from('presencas').select('*');
        const data = { ritmistas: r||[], ensaios: e||[], presencas: p||[], ranks: loadLocal(RANK_KEY), notes: loadLocal(NOTES_KEY) };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const ts = new Date().toISOString().replace(/[:.]/g,'-');
        a.href = url; a.download = `bateria_backup_${ts}.json`; a.click();
        setTimeout(()=> URL.revokeObjectURL(url), 2000);
      };

      const restoreData = async (file) => {
        try {
          const txt = await file.text();
          const data = JSON.parse(txt);
          if (!data || !data.ritmistas || !data.ensaios || !data.presencas) { alert('Arquivo inv√°lido.'); return; }
          if (!confirm('Isso vai substituir os dados atuais. Continuar?')) return;
          const { error: e1 } = await supabase.from('presencas').delete().neq('id', null);
          const { error: e2 } = await supabase.from('ensaios').delete().neq('id', null);
          const { error: e3 } = await supabase.from('ritmistas').delete().neq('id', null);
          if (e1||e2||e3) { console.error(e1||e2||e3); alert('Falha ao limpar dados remotos.'); return; }
          const { error: i1 } = await supabase.from('ritmistas').insert(data.ritmistas||[]);
          if (i1) { console.error(i1); alert('Falha ao importar ritmistas'); return; }
          const { error: i2 } = await supabase.from('ensaios').insert(data.ensaios||[]);
          if (i2) { console.error(i2); alert('Falha ao importar ensaios'); return; }
          const { error: i3 } = await supabase.from('presencas').insert(data.presencas||[]);
          if (i3) { console.error(i3); alert('Falha ao importar presen√ßas'); return; }
          saveLocal(RANK_KEY, data.ranks||{});
          saveLocal(NOTES_KEY, data.notes||{});
          alert('Backup restaurado no Supabase!');
          location.hash = '#dashboard';
        } catch (e) {
          console.error(e); alert('Falha ao restaurar backup.');
        }
      };

      $('#btn-backup').addEventListener('click', exportData);
      $('#file-restore').addEventListener('change', (e)=>{
        const f = e.target.files && e.target.files[0];
        if (f) restoreData(f);
      });
    }

    // ===== Router =====
    async function router() {
      await ensureSeed();
      const hash = (location.hash||'#dashboard').replace('#','');
      if (hash==='dashboard') return pageDashboard();
      if (hash==='ritmistas') return pageRitmistas();
      if (hash==='calendario') return pageCalendario();
      if (hash==='backup') return pageBackup();
      if (hash.startsWith('ensaio:')) return pageEnsaioDetail(hash.split(':')[1]);
      if (hash.startsWith('ritmista:')) return pageRitmistaDetail(hash.split(':')[1]);
      return pageDashboard();
    }
    window.addEventListener('hashchange', router);
    router();
  </script>
</body>
</html>
