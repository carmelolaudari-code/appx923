<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bateria Suite</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
  <style>
    :root { --ink:#111827; --muted:#6b7280; --line:#e5e7eb; }
    *{ box-sizing:border-box }
    body{ font-family:Inter,system-ui; color:var(--ink); margin:0; }
    .top{ display:flex; gap:10px; padding:12px 16px; border-bottom:1px solid var(--line); align-items:center; }
    .brand{ font-weight:800; }
    .nav a{ margin-right:8px; text-decoration:none; color:#111; }
    .nav a.active{ font-weight:700; }
    .wrap{ padding:16px; }
    .card{ border:1px solid var(--line); border-radius:12px; padding:12px; }
    .btn{ padding:8px 12px; border-radius:12px; border:1px solid var(--line); background:#fff; cursor:pointer }
    .btn-dark{ background:#111; color:#fff; border-color:#111 }
    .btn-green{ background:#10b981; color:#fff; border-color:#10b981 }
    .grid-rit{ display:grid; grid-template-columns: repeat(4, 1fr); gap:12px }
    @media (max-width:1000px){ .grid-rit{ grid-template-columns: repeat(2, 1fr)} }
    @media (max-width:640px){ .grid-rit{ grid-template-columns: 1fr } }
    .badge{ border:1px solid var(--line); border-radius:10px; padding:2px 6px; font-size:12px }
    input, select, textarea{ width:100%; padding:10px; border:1px solid var(--line); border-radius:10px }
    table{ width:100%; border-collapse:collapse; font-size:14px }
    th, td{ border-bottom:1px solid var(--line); padding:8px; text-align:left }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    // ===== Supabase Init =====
    const SUPABASE_URL = "https://eauzqljvfbleavkrzouq.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhdXpxbGp2ZmJsZWF2a3J6b3VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzQ1NTgsImV4cCI6MjA3MzY1MDU1OH0.iKyMJ3NUHwDBG4hhdrdHyrX-Of3IT_INuN3nBcocSpY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let CURRENT_UID = null;

    // ===== UI helpers =====
    const $ = (s, r=document) => r.querySelector(s);
    const el = (tag, cls='', html='') => { const x=document.createElement(tag); if(cls) x.className=cls; if(html) x.innerHTML=html; return x; };
    function topbar(active='dashboard'){
      const root = el('div','top');
      root.innerHTML = `<div class="brand">Bateria</div>
        <div class="nav">
          <a href="#dashboard" class="${active==='dashboard'?'active':''}">Dashboard</a>
          <a href="#ritmistas" class="${active==='ritmistas'?'active':''}">Ritmistas</a>
          <a href="#ensaios" class="${active==='ensaios'?'active':''}">Ensaios</a>
          <a href="#backup" class="${active==='backup'?'active':''}">Backup</a>
        </div>`;
      const userbox = el('div', '', `<span id="emailbox" style="margin-left:auto;color:#555;font-size:12px"></span>
        <button id="logout" class="btn" style="margin-left:8px">Sair</button>`);
      root.append(userbox);
      return root;
    }

    // ===== Auth gate (login + signup + reset) =====
    async function requireAuth() {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        document.body.innerHTML = `
          <div style="max-width:420px;margin:64px auto;font-family:Inter,system-ui">
            <h1 style="font-size:22px;font-weight:800;margin:0 0 8px">Bateria Suite</h1>
            <div id="tabs" style="display:flex;gap:8px;margin:10px 0 14px">
              <button id="tab-login" style="flex:1;padding:8px;border-radius:10px;border:1px solid #ddd;background:#000;color:#fff">Entrar</button>
              <button id="tab-signup" style="flex:1;padding:8px;border-radius:10px;border:1px solid #ddd;background:#fff">Criar conta</button>
            </div>
            <div id="view"></div>
            <div id="msg" style="color:#666;margin-top:10px;font-size:12px"></div>
          </div>`;
        const view = document.getElementById('view');
        const msg = document.getElementById('msg');
        const renderLogin = () => {
          view.innerHTML = `
            <label style="display:block;font-size:12px;color:#444">Email</label>
            <input id="email" placeholder="email">
            <label style="display:block;font-size:12px;color:#444;margin-top:6px">Senha</label>
            <input id="pass" type="password" placeholder="senha">
            <div style="margin-top:10px">
              <button id="signin" class="btn btn-dark">Entrar</button>
              <button id="reset" class="btn" style="margin-left:8px">Esqueci a senha</button>
            </div>`;
          $('#signin').onclick = async () => {
            msg.textContent = '';
            const email = $('#email').value.trim();
            const pass = $('#pass').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password: pass });
            if (error) msg.textContent = error.message; else location.reload();
          };
          $('#reset').onclick = async () => {
            msg.textContent = 'Enviando email de recuperação...';
            const email = $('#email').value.trim();
            const { error } = await supabase.auth.resetPasswordForEmail(email, { redirectTo: location.origin });
            msg.textContent = error ? error.message : 'Se existir conta, um email foi enviado.';
          };
        };
        const renderSignup = () => {
          view.innerHTML = `
            <label style="display:block;font-size:12px;color:#444">Email</label>
            <input id="semail" placeholder="email">
            <label style="display:block;font-size:12px;color:#444;margin-top:6px">Senha</label>
            <input id="spass" type="password" placeholder="senha (mín. 6)">
            <div style="margin-top:10px">
              <button id="signup" class="btn btn-dark">Criar conta</button>
            </div>`;
          $('#signup').onclick = async () => {
            msg.textContent = '';
            const email = $('#semail').value.trim();
            const pass = $('#spass').value;
            const { error } = await supabase.auth.signUp({ email, password: pass, options: { emailRedirectTo: location.origin } });
            msg.textContent = error ? error.message : 'Conta criada! Verifique seu email (se exigido) e faça login.';
          };
        };
        renderLogin();
        $('#tab-login').onclick = () => { 
          $('#tab-login').style.background='#000'; $('#tab-login').style.color='#fff';
          $('#tab-signup').style.background='#fff'; $('#tab-signup').style.color='#000';
          renderLogin(); 
        };
        $('#tab-signup').onclick = () => { 
          $('#tab-signup').style.background='#000'; $('#tab-signup').style.color='#fff';
          $('#tab-login').style.background='#fff'; $('#tab-login').style.color='#000';
          renderSignup(); 
        };
        throw new Error('no-auth');
      }
      CURRENT_UID = user.id;
      return user;
    }

    // ===== DAO (Supabase) =====
    async function listRitmistas(q=''){
      const base = supabase.from('ritmistas').select('*').eq('user_id', CURRENT_UID);
      const qry = q ? base.ilike('nome', `%${q}%`) : base;
      const { data, error } = await qry.order('nome', { ascending: true });
      if (error) { console.error(error); return []; }
      return data || [];
    }
    async function getRitmista(id){
      const { data, error } = await supabase.from('ritmistas').select('*').eq('user_id', CURRENT_UID).eq('id', id).single();
      if (error) { console.error(error); return null; }
      return data;
    }
    async function createRitmista(fields){
      const { data, error } = await supabase.from('ritmistas').insert({ user_id: CURRENT_UID, ...fields }).select().single();
      if (error) { console.error(error); alert('Erro ao criar ritmista'); return null; }
      return data;
    }
    async function updateRitmista(id, fields){
      const { error } = await supabase.from('ritmistas').update(fields).eq('user_id', CURRENT_UID).eq('id', id);
      if (error) { console.error(error); alert('Erro ao atualizar ritmista'); }
    }
    async function deleteRitmista(id){
      const { error: e1 } = await supabase.from('presencas').delete().eq('user_id', CURRENT_UID).eq('ritmista_id', id);
      if (e1) console.error(e1);
      const { error } = await supabase.from('ritmistas').delete().eq('user_id', CURRENT_UID).eq('id', id);
      if (error) { console.error(error); alert('Erro ao apagar ritmista'); }
    }

    async function listEnsaios(){
      const { data, error } = await supabase.from('ensaios').select('*').eq('user_id', CURRENT_UID).order('data', { ascending: false });
      if (error) { console.error(error); return []; }
      return data || [];
    }
    async function getEnsaio(id){
      const { data, error } = await supabase.from('ensaios').select('*').eq('user_id', CURRENT_UID).eq('id', id).single();
      if (error) { console.error(error); return null; }
      return data;
    }
    async function createEnsaio(dateISO, obs){
      const { data, error } = await supabase.from('ensaios').insert({ user_id: CURRENT_UID, data: dateISO, observacoes: obs||'' }).select().single();
      if (error) { console.error(error); alert('Erro ao criar ensaio'); return null; }
      return data;
    }
    async function updateEnsaio(id, fields){
      const { error } = await supabase.from('ensaios').update(fields).eq('user_id', CURRENT_UID).eq('id', id);
      if (error) { console.error(error); alert('Erro ao atualizar ensaio'); }
    }
    async function deleteEnsaio(id){
      let { error } = await supabase.from('presencas').delete().eq('user_id', CURRENT_UID).eq('ensaio_id', id);
      if (error) { console.error(error); alert('Erro removendo presenças'); }
      const { error: e2 } = await supabase.from('ensaios').delete().eq('user_id', CURRENT_UID).eq('id', id);
      if (e2) { console.error(e2); alert('Erro removendo ensaio'); }
    }
    async function listPresencasByEnsaio(ensaioId){
      const { data, error } = await supabase.from('presencas').select('*').eq('user_id', CURRENT_UID).eq('ensaio_id', ensaioId);
      if (error) { console.error(error); return []; }
      return data || [];
    }
    async function setPresencasForEnsaio(ensaioId, selectedIds, markAbsent=true){
      let { error } = await supabase.from('presencas').delete().eq('user_id', CURRENT_UID).eq('ensaio_id', ensaioId);
      if (error) { console.error(error); alert('Erro limpando presenças'); return; }
      const ritRows = await listRitmistas();
      const allIds = ritRows.map(r => String(r.id));
      const rows = [];
      allIds.forEach(id => {
        if (selectedIds.includes(String(id))) rows.push({ user_id: CURRENT_UID, ensaio_id: ensaioId, ritmista_id: id, status: 'PRESENTE', observacoes: '' });
        else if (markAbsent) rows.push({ user_id: CURRENT_UID, ensaio_id: ensaioId, ritmista_id: id, status: 'AUSENTE', observacoes: '' });
      });
      if (rows.length){
        const res = await supabase.from('presencas').insert(rows);
        if (res.error) { console.error(res.error); alert('Erro salvando presenças'); }
      }
    }

    // ===== Pages =====
    function top(active){ const t = topbar(active); t.querySelector('#logout').onclick = async()=>{ await supabase.auth.signOut(); location.reload(); }; return t; }

    async function pageDashboard(){
      const app = document.getElementById('app'); app.innerHTML=''; app.append(top('dashboard'));
      const wrap = el('div','wrap'); app.append(wrap);
      wrap.append(el('div','card', '<div class="font-semibold">Bem-vindo!</div><div class="text-sm" style="color:#666">Use o menu acima para navegar.</div>'));
    }

    async function pageRitmistas(){
      const app = document.getElementById('app'); app.innerHTML=''; app.append(top('ritmistas'));
      const wrap = el('div','wrap'); app.append(wrap);
      const header = el('div','',`<div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:8px 0">Ritmistas</h2>
        <div>
          <button id="btn-add" class="btn btn-green">+ Novo</button>
          <button id="btn-import" class="btn" style="margin-left:8px">Importar (Excel/CSV)</button>
        </div></div>`);
      wrap.append(header);

      const search = el('div','', '<input id="q" placeholder="Buscar por nome...">'); wrap.append(search);
      const grid = el('div','grid-rit'); wrap.append(grid);

      async function render(list){
        grid.innerHTML='';
        list.forEach(r => {
          const c = el('div','card', `
            <div class="font-semibold">${r.nome||'-'}</div>
            <div style="font-size:12px;color:#666">${r.apelido||''}</div>
            <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap">
              <a class="btn" href="#ritmista:${r.id}">Perfil</a>
              <button class="btn" data-edit="${r.id}">Editar</button>
              <button class="btn" data-del="${r.id}">Apagar</button>
            </div>`);
          grid.append(c);
        });
        grid.querySelectorAll('[data-edit]').forEach(btn => btn.onclick = async (e)=>{
          const id = e.currentTarget.getAttribute('data-edit');
          const r = await getRitmista(id); if (!r) return;
          const nome = prompt('Nome', r.nome||''); if (nome===null) return;
          const apelido = prompt('Apelido', r.apelido||''); if (apelido===null) return;
          const telefone = prompt('Telefone', r.telefone||''); if (telefone===null) return;
          const camiseta = prompt('Camiseta', r.camiseta||''); if (camiseta===null) return;
          const calca = prompt('Calça', r.calca||''); if (calca===null) return;
          const sapato = prompt('Sapato', r.sapato||''); if (sapato===null) return;
          await updateRitmista(id, { nome, apelido, telefone, camiseta, calca, sapato });
          load();
        });
        grid.querySelectorAll('[data-del]').forEach(btn => btn.onclick = async (e)=>{
          const id = e.currentTarget.getAttribute('data-del');
          const r = await getRitmista(id); if (!r) return;
          if (!confirm('Apagar ritmista "'+(r.nome||id)+'"?')) return;
          await deleteRitmista(id);
          load();
        });
      }
      async function load(){
        const list = await listRitmistas((document.getElementById('q').value||'').trim());
        render(list);
      }
      document.getElementById('q').oninput = load;
      document.getElementById('btn-add').onclick = async ()=>{
        const nome = prompt('Nome'); if (!nome) return;
        await createRitmista({ nome, apelido:'', telefone:'', camiseta:'', calca:'', sapato:'' });
        load();
      };

      // Import Excel/CSV
      document.getElementById('btn-import').onclick = ()=>{
        const input = document.createElement('input'); input.type='file'; input.accept='.xlsx,.xls,.csv';
        input.onchange = async (e)=>{
          const file = e.target.files && e.target.files[0]; if (!file) return;
          const buf = await file.arrayBuffer();
          const fname = (file.name||'').toLowerCase();
          let rows = [];
          const normalizeRows = (arr) => arr.map(o => { 
            const k = {}; Object.keys(o).forEach(key => k[String(key).trim().toLowerCase()] = o[key]);
            return { id: k['id']||undefined, nome: k['nome']||'', apelido: k['apelido']||'', telefone: k['telefone']||'', camiseta: k['camiseta']||'', calca: k['calca']||'', sapato: k['sapato']||'' };
          });
          try{
            if (fname.endsWith('.xlsx') || fname.endsWith('.xls')){ 
              const wb = XLSX.read(buf, { type:'array' }); const ws = wb.Sheets[wb.SheetNames[0]]; rows = normalizeRows(XLSX.utils.sheet_to_json(ws, { defval:'' }));
            } else {
              const text = new TextDecoder().decode(new Uint8Array(buf));
              const lines = text.split(/\\r?\\n/).filter(Boolean); const cols = lines.shift().split(',').map(s=>s.trim().toLowerCase());
              const idx = (name) => cols.indexOf(name);
              rows = lines.map(line => { const parts = line.split(','); const get = n => parts[idx(n)]||''; return { id:get('id')||undefined, nome:get('nome'), apelido:get('apelido'), telefone:get('telefone'), camiseta:get('camiseta'), calca:get('calca'), sapato:get('sapato') };});
            }
          }catch(err){ alert('Falha ao ler arquivo'); console.error(err); return; }
          const payload = rows.map(r => ({ user_id: CURRENT_UID, ...r }));
          const { error } = await supabase.from('ritmistas').upsert(payload);
          if (error) { console.error(error); alert('Erro ao importar'); return; }
          load(); alert('Importado!');
        };
        input.click();
      };

      load();
    }

    async function pageRitmistaDetail(id){
      const r = await getRitmista(id);
      const app = document.getElementById('app'); app.innerHTML=''; app.append(top('ritmistas'));
      const w = el('div','wrap'); app.append(w);
      if (!r) { w.append(el('div','card','Ritmista não encontrado.')); return; }
      w.append(el('div','card',`
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div class="font-semibold" style="font-size:18px">${r.nome||'-'}</div>
            <div style="font-size:12px;color:#666">${r.apelido||''}</div>
          </div>
          <a class="btn" href="#ritmistas">Voltar</a>
        </div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px">
          <div><label>Telefone</label><div>${r.telefone||'—'}</div></div>
          <div><label>Camiseta</label><div>${r.camiseta||'—'}</div></div>
          <div><label>Calça</label><div>${r.calca||'—'}</div></div>
          <div><label>Sapato</label><div>${r.sapato||'—'}</div></div>
        </div>`));
    }

    async function pageEnsaios(){
      const app = document.getElementById('app'); app.innerHTML=''; app.append(top('ensaios'));
      const wrap = el('div','wrap'); app.append(wrap);
      const header = el('div','',`<div style="display:flex;justify-content:space-between;align-items:center">
        <h2 style="margin:8px 0">Ensaios</h2>
        <button id="btn-add-ensaio" class="btn btn-green">+ Adicionar</button>
      </div>`);
      wrap.append(header);
      const list = el('div',''); wrap.append(list);

      async function render(){
        list.innerHTML='';
        const ens = await listEnsaios();
        if(!ens.length){ list.append(el('div','card','Nenhum ensaio cadastrado.')); return; }
        ens.forEach(e => {
          const row = el('div','card',`
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="font-semibold">${e.data}</div>
                <div style="font-size:12px;color:#666">${e.observacoes||'—'}</div>
              </div>
              <div style="display:flex;gap:6px;flex-wrap:wrap">
                <a class="btn btn-dark" href="#ensaio:${e.id}">Entrar</a>
                <button class="btn" data-edit="${e.id}">Editar</button>
                <button class="btn" data-del="${e.id}">Excluir</button>
              </div>
            </div>`);
          list.append(row);
        });
        list.querySelectorAll('[data-del]').forEach(b => b.onclick = async (ev)=>{
          const id = ev.currentTarget.getAttribute('data-del');
          if (!confirm('Excluir ensaio?')) return;
          await deleteEnsaio(id); render();
        });
        list.querySelectorAll('[data-edit]').forEach(b => b.onclick = async (ev)=>{
          const id = ev.currentTarget.getAttribute('data-edit');
          const ens = await getEnsaio(id); if (!ens) return;
          const data = prompt('Data (AAAA-MM-DD):', ens.data||'') || ens.data;
          const obs = prompt('Observações:', ens.observacoes||'') ?? ens.observacoes;
          await updateEnsaio(id, { data, observacoes: obs }); render();
        });
      }
      document.getElementById('btn-add-ensaio').onclick = async ()=>{
        const d = prompt('Data do ensaio (AAAA-MM-DD):'); if (!d) return;
        const o = prompt('Observações:')||'';
        await createEnsaio(d, o); render();
      };
      render();
    }

    async function pageEnsaioDetail(id){
      const app = document.getElementById('app'); app.innerHTML=''; app.append(top('ensaios'));
      const wrap = el('div','wrap'); app.append(wrap);
      const e = await getEnsaio(id);
      if (!e) { wrap.append(el('div','card','Ensaio não encontrado.')); return; }
      wrap.append(el('div','card',`
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><div class="font-semibold">Ensaio ${e.data}</div><div style="font-size:12px;color:#666">${e.observacoes||'—'}</div></div>
          <a class="btn" href="#ensaios">Voltar</a>
        </div>`));
      const checklist = el('div','card',''); wrap.append(checklist);

      const rit = await listRitmistas();
      const pres = await listPresencasByEnsaio(id);
      const statusMap = {}; pres.forEach(p => statusMap[String(p.ritmista_id)] = p.status || 'AUSENTE');

      checklist.innerHTML = `<div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <button id="save" class="btn btn-dark">Salvar presenças</button>
        <label style="font-size:12px;color:#666"><input type="checkbox" id="mark-abs" checked> Marcar ausentes automaticamente</label>
      </div>
      <div style="display:grid;grid-template-columns: repeat(2,1fr);gap:8px">
        ${rit.map(r => `
          <label class="card" style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" data-id="${r.id}" ${statusMap[String(r.id)]==='PRESENTE'?'checked':''}>
            <div>${r.nome}</div>
          </label>`).join('')}
      </div>`;

      document.getElementById('save').onclick = async ()=>{
        const ids = Array.from(checklist.querySelectorAll('input[type=checkbox][data-id]:checked')).map(i => i.getAttribute('data-id'));
        const markAbsent = document.getElementById('mark-abs').checked;
        await setPresencasForEnsaio(id, ids, markAbsent);
        alert('Presenças salvas.');
      };
    }

    async function pageBackup(){
      const app = document.getElementById('app'); app.innerHTML=''; app.append(top('backup'));
      const wrap = el('div','wrap'); app.append(wrap);
      const card = el('div','card'); wrap.append(card);
      card.innerHTML = `
        <div class="font-semibold">Backup & Restauração</div>
        <div style="color:#666;font-size:12px;margin:6px 0 10px">Exporta/importa seus dados deste usuário.</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <button id="btn-backup" class="btn btn-dark">Gerar backup (.json)</button>
          <label class="btn"><input id="restore" type="file" accept=".json" style="display:none"> Importar backup (.json)</label>
        </div>`;

      document.getElementById('btn-backup').onclick = async ()=>{
        const { data: r } = await supabase.from('ritmistas').select('*').eq('user_id', CURRENT_UID);
        const { data: e } = await supabase.from('ensaios').select('*').eq('user_id', CURRENT_UID);
        const { data: p } = await supabase.from('presencas').select('*').eq('user_id', CURRENT_UID);
        const data = { ritmistas: r||[], ensaios: e||[], presencas: p||[] };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const url = URL.createObjectURL(blob); const a = document.createElement('a');
        a.href = url; a.download = 'bateria_backup_'+new Date().toISOString().replace(/[:.]/g,'-')+'.json'; a.click();
        setTimeout(()=> URL.revokeObjectURL(url), 2000);
      };
      document.getElementById('restore').onchange = async (e)=>{
        const file = e.target.files && e.target.files[0]; if (!file) return;
        const txt = await file.text(); let data;
        try { data = JSON.parse(txt); } catch { alert('Arquivo inválido'); return; }
        if (!confirm('Isto substituirá SEUS dados (deste usuário). Continuar?')) return;
        await supabase.from('presencas').delete().eq('user_id', CURRENT_UID);
        await supabase.from('ensaios').delete().eq('user_id', CURRENT_UID);
        await supabase.from('ritmistas').delete().eq('user_id', CURRENT_UID);
        if (data.ritmistas?.length) await supabase.from('ritmistas').insert(data.ritmistas.map(x=>({user_id:CURRENT_UID,...x, id:undefined})));
        if (data.ensaios?.length) await supabase.from('ensaios').insert(data.ensaios.map(x=>({user_id:CURRENT_UID,...x, id:undefined})));
        if (data.presencas?.length) await supabase.from('presencas').insert(data.presencas.map(x=>({user_id:CURRENT_UID,...x, id:undefined})));
        alert('Backup restaurado!'); location.hash = '#dashboard';
      };
    }

    // ===== Router =====
    async function router(){
      const hash = (location.hash||'').replace('#','');
      if (hash.startsWith('ritmista:')) return pageRitmistaDetail(hash.split(':')[1]);
      if (hash.startsWith('ensaio:')) return pageEnsaioDetail(hash.split(':')[1]);
      if (hash==='ritmistas') return pageRitmistas();
      if (hash==='ensaios') return pageEnsaios();
      if (hash==='backup') return pageBackup();
      return pageDashboard();
    }
    window.addEventListener('hashchange', router);

    // Start after auth
    requireAuth().then(async (u)=>{
      document.body.innerHTML = '<div id="app"></div>';
      document.getElementById('app').append(topbar('dashboard'));
      document.getElementById('emailbox').textContent = u.email||'';
      router();
    }).catch(()=>{});
  </script>
</body>
</html>