<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bateria Suite — Diagnóstico</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; padding:16px}
    .card{border:1px solid #e5e7eb; border-radius:12px; padding:12px; margin-bottom:12px}
    .ok{color:#059669} .err{color:#b91c1c} .muted{color:#6b7280}
    code{background:#f8fafc; padding:2px 4px; border-radius:6px}
    pre{background:#0b1021; color:#e2e8f0; padding:12px; border-radius:12px; overflow:auto}
  </style>
</head>
<body>
  <h1>Diagnóstico Supabase</h1>
  <div id="out" class="card"></div>
  <div class="card">
    <button id="logout">Sair (signOut)</button>
  </div>
  <pre id="log"></pre>
<script>
const logEl = document.getElementById('log');
function log(...args){
  console.log(...args);
  logEl.textContent += args.map(a => typeof a==='string' ? a : JSON.stringify(a, null, 2)).join(' ') + "\\n";
}
const out = document.getElementById('out');

// === CONFIGURE ===
const SUPABASE_URL = "https://eauzqljvfbleavkrzouq.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhdXpxbGp2ZmJsZWF2a3J6b3VxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwNzQ1NTgsImV4cCI6MjA3MzY1MDU1OH0.iKyMJ3NUHwDBG4hhdrdHyrX-Of3IT_INuN3nBcocSpY";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function render(html){ out.innerHTML = html; }

async function main(){
  render('<div class="muted">Iniciando...</div>');
  // 1) Teste simples: fetch /auth/v1/settings (ver CORS)
  try{
    const r = await fetch(SUPABASE_URL + '/auth/v1/settings', { headers: { apikey: SUPABASE_ANON_KEY } });
    log('Auth settings status', r.status);
    if (!r.ok){
      render(`<div class="err">Falha ao acessar Supabase Auth (CORS/domínio não permitido?). Status ${r.status}</div>`);
      return;
    }
  }catch(e){
    log('fetch error', e);
    render('<div class="err">Erro de rede/CORS acessando Supabase.</div>');
    return;
  }

  // 2) Estado de auth
  const { data: { user }, error: uerr } = await supabase.auth.getUser();
  log('getUser', {user, uerr});
  if (!user){
    render(`<div class="card">
      <div style="font-weight:700">Login</div>
      <div><input id="email" placeholder="email" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px;width:260px"></div>
      <div style="margin-top:6px"><input id="pass" type="password" placeholder="senha" style="padding:8px;border:1px solid #e5e7eb;border-radius:8px;width:260px"></div>
      <div style="margin-top:8px">
        <button id="signin">Entrar</button>
        <button id="signup">Criar conta</button>
      </div>
      <div id="msg" class="muted" style="margin-top:8px"></div>
    </div>`);
    document.getElementById('signin').onclick = async ()=>{
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('pass').value;
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      log('signin error', error);
      document.getElementById('msg').textContent = error ? error.message : 'OK — recarregue a página.';
    };
    document.getElementById('signup').onclick = async ()=>{
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('pass').value;
      const { error } = await supabase.auth.signUp({ email, password, options:{ emailRedirectTo: location.href }});
      log('signup error', error);
      document.getElementById('msg').textContent = error ? error.message : 'Conta criada. Verifique o e-mail (se exigido).';
    };
    return;
  }

  render(`<div><span class="ok">Logado:</span> ${user.email}</div>`);

  // 3) Teste de SELECT por tabela (ver 'relation does not exist' e RLS)
  try{
    let res;
    res = await supabase.from('ritmistas').select('id').limit(1);
    log('ritmistas', res);
    if (res.error){
      render(`<div class="err">Erro em ritmistas: ${res.error.message}</div>`);
      return;
    }
    res = await supabase.from('ensaios').select('id').limit(1);
    log('ensaios', res);
    if (res.error){
      render(`<div class="err">Erro em ensaios: ${res.error.message}</div>`);
      return;
    }
    res = await supabase.from('presencas').select('id').limit(1);
    log('presencas', res);
    if (res.error){
      render(`<div class="err">Erro em presencas: ${res.error.message}</div>`);
      return;
    }
    render(`<div class="ok">Consegui ler as 3 tabelas — esquema e RLS parecem OK.</div>
    <div class="muted">Se o app completo continuar em branco, o erro é de JS/roteamento. Me mande o console.</div>`);
  }catch(e){
    log('select error', e);
    render(`<div class="err">Falha inesperada ao consultar tabelas.</div>`);
  }
}

document.getElementById('logout').onclick = async ()=>{
  await supabase.auth.signOut(); location.reload();
};

main();
</script>
</body>
</html>